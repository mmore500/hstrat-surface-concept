import numpy as np
import pytest

from hsurf.hsurf import steady_algo as algo
from hsurf.pylib.hanoi import (
    get_hanoi_value_at_index,
    get_incidence_count_of_hanoi_value_through_index,
)


@pytest.mark.parametrize("surface_size", [8, 16, 32, 64, 128])
@pytest.mark.parametrize(
    "rank",
    [
        *range(300),
        *map(int, np.linspace(0, 2**62, 10**2, dtype=int)),
        *map(int, np.geomspace(1, 2**62, 10**2, dtype=int)),
        *map(int, np.random.RandomState(seed=1).randint(0, 2**62, 10**2)),
    ],
)
def test_pick_deposition_site_smoke(surface_size: int, rank: int) -> int:
    # just a smoke test
    deposit_site = algo.pick_deposition_site(rank, surface_size)
    assert isinstance(deposit_site, int)
    assert 0 <= deposit_site < surface_size


@pytest.mark.parametrize("surface_size", [2**exp for exp in range(2, 12)])
@pytest.mark.parametrize(
    "num_generations",
    [2**12, pytest.param(2**18, marks=pytest.mark.heavy)],
)
def test_pick_deposition_site_hanoi_value_overwrite_order(
    surface_size: int,
    num_generations: int,
):
    num_available_bins = surface_size // 2
    surface_hanoi_values = [-1] * surface_size
    for rank in range(num_generations):
        target_site = algo.pick_deposition_site(rank, surface_size)
        if rank == 0:  # deal with special-casing the 0th deposition
            continue
        deposited_hanoi_value = get_hanoi_value_at_index(rank)
        deposited_hanoi_incidence = (
            get_incidence_count_of_hanoi_value_through_index(
                deposited_hanoi_value, rank
            )
        )
        resident_hanoi_value = surface_hanoi_values[target_site]
        surface_hanoi_values[target_site] = deposited_hanoi_value
        if resident_hanoi_value == -1:
            continue
        resident_hanoi_incidence = (
            get_incidence_count_of_hanoi_value_through_index(
                resident_hanoi_value, rank
            )
        )
        assert resident_hanoi_incidence >= num_available_bins
        if deposited_hanoi_incidence <= num_available_bins:
            assert deposited_hanoi_value > resident_hanoi_value


@pytest.mark.parametrize(
    "rank, surface_size, expected_result",
    [
        (0, 8, 1),
        (1, 8, 2),
        (2, 8, 4),
        (3, 8, 3),
        (4, 8, 6),
        (5, 8, 5),
        (6, 8, 7),
        (7, 8, 1),
        (8, 8, 6),
        (9, 8, 6),
        (10, 8, 4),
        (11, 8, 4),
        (12, 8, 7),
        (13, 8, 7),
        (14, 8, 2),
        (15, 8, 2),
        (16, 8, 6),
        (17, 8, 6),
        (18, 8, 6),
        (19, 8, 6),
        (20, 8, 5),
        (21, 8, 5),
        (22, 8, 5),
        (23, 8, 5),
        (24, 8, 7),
        (25, 8, 7),
        (26, 8, 7),
        (27, 8, 7),
        (28, 8, 3),
        (29, 8, 3),
        (30, 8, 3),
        (31, 8, 3),
        (32, 8, 6),
        (33, 8, 6),
        (34, 8, 6),
        (35, 8, 6),
        (36, 8, 6),
        (37, 8, 6),
        (38, 8, 6),
        (39, 8, 6),
        (40, 8, 4),
        (41, 8, 4),
        (42, 8, 4),
        (43, 8, 4),
        (44, 8, 4),
        (45, 8, 4),
        (46, 8, 4),
        (47, 8, 4),
        (48, 8, 7),
        (49, 8, 7),
        (50, 8, 7),
        (51, 8, 7),
        (52, 8, 7),
        (53, 8, 7),
        (54, 8, 7),
        (55, 8, 7),
        (56, 8, 1),
        (57, 8, 1),
        (58, 8, 1),
        (59, 8, 1),
        (60, 8, 1),
        (61, 8, 1),
        (62, 8, 1),
        (63, 8, 1),
        (64, 8, 6),
        (65, 8, 6),
        (66, 8, 6),
        (67, 8, 6),
        (68, 8, 6),
        (69, 8, 6),
        (70, 8, 6),
        (71, 8, 6),
        (72, 8, 6),
        (73, 8, 6),
        (74, 8, 6),
        (75, 8, 6),
        (76, 8, 6),
        (77, 8, 6),
        (78, 8, 6),
        (79, 8, 6),
        (80, 8, 5),
        (81, 8, 5),
        (82, 8, 5),
        (83, 8, 5),
        (84, 8, 5),
        (85, 8, 5),
        (86, 8, 5),
        (87, 8, 5),
        (88, 8, 5),
        (89, 8, 5),
        (90, 8, 5),
        (91, 8, 5),
        (92, 8, 5),
        (93, 8, 5),
        (94, 8, 5),
        (95, 8, 5),
        (96, 8, 7),
        (97, 8, 7),
        (98, 8, 7),
        (99, 8, 7),
        (717354021, 8, 4),
        (1061650667, 8, 1),
        (946286476, 8, 1),
        (784077896, 8, 4),
        (491263, 8, 2),
        (550290313, 8, 6),
        (224766667, 8, 7),
        (1069620869, 8, 1),
        (630311759, 8, 6),
        (1013994432, 8, 1),
        (396591248, 8, 5),
        (629559425, 8, 6),
        (799981516, 8, 4),
        (592322119, 8, 6),
        (410430189, 8, 7),
        (729053692, 8, 4),
        (630361478, 8, 6),
        (796884249, 8, 4),
        (166716594, 8, 6),
        (413652244, 8, 7),
        (726684926, 8, 4),
        (271757669, 8, 6),
        (795511698, 8, 4),
        (105433556, 8, 7),
        (878115723, 8, 7),
        (830873852, 8, 7),
        (550260202, 8, 6),
        (986026652, 8, 1),
        (117628829, 8, 1),
        (147806606, 8, 6),
        (732152370, 8, 4),
        (704211524, 8, 4),
        (718568663, 8, 4),
        (889937879, 8, 7),
        (252070889, 8, 2),
        (776094449, 8, 4),
        (602957303, 8, 6),
        (812297694, 8, 7),
        (850839392, 8, 7),
        (121930838, 8, 1),
        (217946253, 8, 7),
        (927586281, 8, 7),
        (937426313, 8, 7),
        (226591751, 8, 7),
        (272404799, 8, 6),
        (398576445, 8, 5),
        (826019350, 8, 7),
        (77964601, 8, 6),
        (542837249, 8, 6),
        (494008192, 8, 3),
        (621080892, 8, 6),
        (339933393, 8, 5),
        (365262088, 8, 5),
        (341893848, 8, 5),
        (167739021, 8, 6),
        (98998899, 8, 5),
        (729416111, 8, 4),
        (254447594, 8, 2),
        (550367865, 8, 6),
        (732412360, 8, 4),
        (422396446, 8, 7),
        (399713351, 8, 5),
        (734901635, 8, 4),
        (737248710, 8, 4),
        (892878741, 8, 7),
        (694873649, 8, 4),
        (142443833, 8, 6),
        (848474627, 8, 7),
        (824105924, 8, 7),
        (170208024, 8, 4),
        (281387505, 8, 6),
        (610401323, 8, 6),
        (801015372, 8, 4),
        (143084570, 8, 6),
        (363464500, 8, 5),
        (698099024, 8, 4),
        (78547565, 8, 6),
        (146764659, 8, 6),
        (619817, 8, 6),
        (532704722, 8, 3),
        (1025900559, 8, 1),
        (689925184, 8, 4),
        (1065863364, 8, 1),
        (208285721, 8, 7),
        (130755951, 8, 1),
        (842391266, 8, 7),
        (168703447, 8, 4),
        (954017671, 8, 1),
        (443352346, 8, 7),
        (315096729, 8, 6),
        (849946216, 8, 7),
        (941622294, 8, 1),
        (681162505, 8, 4),
        (413056707, 8, 7),
        (187321319, 8, 4),
        (658719870, 8, 6),
        (162243863, 8, 6),
        (513207677, 8, 3),
        (558468452, 8, 6),
        (106512539, 8, 7),
        (0, 32, 1),
        (1, 32, 2),
        (2, 32, 6),
        (3, 32, 3),
        (4, 32, 10),
        (5, 32, 7),
        (6, 32, 13),
        (7, 32, 4),
        (8, 32, 16),
        (9, 32, 11),
        (10, 32, 18),
        (11, 32, 8),
        (12, 32, 20),
        (13, 32, 14),
        (14, 32, 22),
        (15, 32, 5),
        (16, 32, 24),
        (17, 32, 17),
        (18, 32, 25),
        (19, 32, 12),
        (20, 32, 26),
        (21, 32, 19),
        (22, 32, 27),
        (23, 32, 9),
        (24, 32, 28),
        (25, 32, 21),
        (26, 32, 29),
        (27, 32, 15),
        (28, 32, 30),
        (29, 32, 23),
        (30, 32, 31),
        (31, 32, 1),
        (32, 32, 24),
        (33, 32, 24),
        (34, 32, 16),
        (35, 32, 16),
        (36, 32, 25),
        (37, 32, 25),
        (38, 32, 10),
        (39, 32, 10),
        (40, 32, 26),
        (41, 32, 26),
        (42, 32, 18),
        (43, 32, 18),
        (44, 32, 27),
        (45, 32, 27),
        (46, 32, 6),
        (47, 32, 6),
        (48, 32, 28),
        (49, 32, 28),
        (50, 32, 20),
        (51, 32, 20),
        (52, 32, 29),
        (53, 32, 29),
        (54, 32, 13),
        (55, 32, 13),
        (56, 32, 30),
        (57, 32, 30),
        (58, 32, 22),
        (59, 32, 22),
        (60, 32, 31),
        (61, 32, 31),
        (62, 32, 2),
        (63, 32, 2),
        (64, 32, 24),
        (65, 32, 24),
        (66, 32, 24),
        (67, 32, 24),
        (68, 32, 17),
        (69, 32, 17),
        (70, 32, 17),
        (71, 32, 17),
        (72, 32, 25),
        (73, 32, 25),
        (74, 32, 25),
        (75, 32, 25),
        (76, 32, 11),
        (77, 32, 11),
        (78, 32, 11),
        (79, 32, 11),
        (80, 32, 26),
        (81, 32, 26),
        (82, 32, 26),
        (83, 32, 26),
        (84, 32, 19),
        (85, 32, 19),
        (86, 32, 19),
        (87, 32, 19),
        (88, 32, 27),
        (89, 32, 27),
        (90, 32, 27),
        (91, 32, 27),
        (92, 32, 7),
        (93, 32, 7),
        (94, 32, 7),
        (95, 32, 7),
        (96, 32, 28),
        (97, 32, 28),
        (98, 32, 28),
        (99, 32, 28),
        (717354021, 32, 18),
        (1061650667, 32, 1),
        (946286476, 32, 30),
        (784077896, 32, 6),
        (491263, 32, 23),
        (550290313, 32, 24),
        (224766667, 32, 29),
        (1069620869, 32, 1),
        (630311759, 32, 25),
        (1013994432, 32, 31),
        (396591248, 32, 9),
        (629559425, 32, 25),
        (799981516, 32, 6),
        (592322119, 32, 16),
        (410430189, 32, 28),
        (729053692, 32, 18),
        (630361478, 32, 25),
        (796884249, 32, 6),
        (166716594, 32, 11),
        (413652244, 32, 28),
        (726684926, 32, 18),
        (271757669, 32, 24),
        (795511698, 32, 6),
        (105433556, 32, 21),
        (878115723, 32, 29),
        (830873852, 32, 28),
        (550260202, 32, 24),
        (986026652, 32, 22),
        (117628829, 32, 30),
        (147806606, 32, 16),
        (732152370, 32, 18),
        (704211524, 32, 26),
        (718568663, 32, 18),
        (889937879, 32, 29),
        (252070889, 32, 31),
        (776094449, 32, 6),
        (602957303, 32, 16),
        (812297694, 32, 28),
        (850839392, 32, 20),
        (121930838, 32, 23),
        (217946253, 32, 20),
        (927586281, 32, 13),
        (937426313, 32, 13),
        (226591751, 32, 14),
        (272404799, 32, 24),
        (398576445, 32, 9),
        (826019350, 32, 28),
        (77964601, 32, 25),
        (542837249, 32, 24),
        (494008192, 32, 23),
        (621080892, 32, 25),
        (339933393, 32, 26),
        (365262088, 32, 19),
        (341893848, 32, 26),
        (167739021, 32, 11),
        (98998899, 32, 7),
        (729416111, 32, 18),
        (254447594, 32, 31),
        (550367865, 32, 24),
        (732412360, 32, 18),
        (422396446, 32, 21),
        (399713351, 32, 9),
        (734901635, 32, 18),
        (737248710, 32, 18),
        (892878741, 32, 29),
        (694873649, 32, 26),
        (142443833, 32, 24),
        (848474627, 32, 20),
        (824105924, 32, 28),
        (170208024, 32, 26),
        (281387505, 32, 24),
        (610401323, 32, 25),
        (801015372, 32, 6),
        (143084570, 32, 16),
        (363464500, 32, 19),
        (698099024, 32, 26),
        (78547565, 32, 25),
        (146764659, 32, 16),
        (619817, 32, 25),
        (532704722, 32, 5),
        (1025900559, 32, 31),
        (689925184, 32, 26),
        (1065863364, 32, 1),
        (208285721, 32, 28),
        (130755951, 32, 3),
        (842391266, 32, 20),
        (168703447, 32, 26),
        (954017671, 32, 30),
        (443352346, 32, 29),
        (315096729, 32, 25),
        (849946216, 32, 20),
        (941622294, 32, 30),
        (681162505, 32, 26),
        (413056707, 32, 28),
        (187321319, 32, 27),
        (658719870, 32, 10),
        (162243863, 32, 11),
        (513207677, 32, 31),
        (558468452, 32, 24),
        (106512539, 32, 21),
        (0, 64, 1),
        (1, 64, 2),
        (2, 64, 7),
        (3, 64, 3),
        (4, 64, 12),
        (5, 64, 8),
        (6, 64, 16),
        (7, 64, 4),
        (8, 64, 20),
        (9, 64, 13),
        (10, 64, 23),
        (11, 64, 9),
        (12, 64, 26),
        (13, 64, 17),
        (14, 64, 29),
        (15, 64, 5),
        (16, 64, 32),
        (17, 64, 21),
        (18, 64, 34),
        (19, 64, 14),
        (20, 64, 36),
        (21, 64, 24),
        (22, 64, 38),
        (23, 64, 10),
        (24, 64, 40),
        (25, 64, 27),
        (26, 64, 42),
        (27, 64, 18),
        (28, 64, 44),
        (29, 64, 30),
        (30, 64, 46),
        (31, 64, 6),
        (32, 64, 48),
        (33, 64, 33),
        (34, 64, 49),
        (35, 64, 22),
        (36, 64, 50),
        (37, 64, 35),
        (38, 64, 51),
        (39, 64, 15),
        (40, 64, 52),
        (41, 64, 37),
        (42, 64, 53),
        (43, 64, 25),
        (44, 64, 54),
        (45, 64, 39),
        (46, 64, 55),
        (47, 64, 11),
        (48, 64, 56),
        (49, 64, 41),
        (50, 64, 57),
        (51, 64, 28),
        (52, 64, 58),
        (53, 64, 43),
        (54, 64, 59),
        (55, 64, 19),
        (56, 64, 60),
        (57, 64, 45),
        (58, 64, 61),
        (59, 64, 31),
        (60, 64, 62),
        (61, 64, 47),
        (62, 64, 63),
        (63, 64, 1),
        (64, 64, 48),
        (65, 64, 48),
        (66, 64, 32),
        (67, 64, 32),
        (68, 64, 49),
        (69, 64, 49),
        (70, 64, 20),
        (71, 64, 20),
        (72, 64, 50),
        (73, 64, 50),
        (74, 64, 34),
        (75, 64, 34),
        (76, 64, 51),
        (77, 64, 51),
        (78, 64, 12),
        (79, 64, 12),
        (80, 64, 52),
        (81, 64, 52),
        (82, 64, 36),
        (83, 64, 36),
        (84, 64, 53),
        (85, 64, 53),
        (86, 64, 23),
        (87, 64, 23),
        (88, 64, 54),
        (89, 64, 54),
        (90, 64, 38),
        (91, 64, 38),
        (92, 64, 55),
        (93, 64, 55),
        (94, 64, 7),
        (95, 64, 7),
        (96, 64, 56),
        (97, 64, 56),
        (98, 64, 40),
        (99, 64, 40),
        (717354021, 64, 53),
        (1061650667, 64, 1),
        (946286476, 64, 60),
        (784077896, 64, 55),
        (491263, 64, 29),
        (550290313, 64, 48),
        (224766667, 64, 43),
        (1069620869, 64, 1),
        (630311759, 64, 35),
        (1013994432, 64, 62),
        (396591248, 64, 9),
        (629559425, 64, 35),
        (799981516, 64, 10),
        (592322119, 64, 22),
        (410430189, 64, 56),
        (729053692, 64, 25),
        (630361478, 64, 35),
        (796884249, 64, 10),
        (166716594, 64, 13),
        (413652244, 64, 40),
        (726684926, 64, 25),
        (271757669, 64, 48),
        (795511698, 64, 10),
        (105433556, 64, 57),
        (878115723, 64, 58),
        (830873852, 64, 41),
        (550260202, 64, 48),
        (986026652, 64, 61),
        (117628829, 64, 60),
        (147806606, 64, 20),
        (732152370, 64, 25),
        (704211524, 64, 37),
        (718568663, 64, 53),
        (889937879, 64, 43),
        (252070889, 64, 62),
        (776094449, 64, 55),
        (602957303, 64, 22),
        (812297694, 64, 56),
        (850839392, 64, 57),
        (121930838, 64, 61),
        (217946253, 64, 26),
        (927586281, 64, 19),
        (937426313, 64, 19),
        (226591751, 64, 59),
        (272404799, 64, 48),
        (398576445, 64, 9),
        (826019350, 64, 41),
        (77964601, 64, 34),
        (542837249, 64, 48),
        (494008192, 64, 61),
        (621080892, 64, 35),
        (339933393, 64, 52),
        (365262088, 64, 24),
        (341893848, 64, 52),
        (167739021, 64, 13),
        (98998899, 64, 7),
        (729416111, 64, 25),
        (254447594, 64, 62),
        (550367865, 64, 48),
        (732412360, 64, 25),
        (422396446, 64, 57),
        (399713351, 64, 9),
        (734901635, 64, 25),
        (737248710, 64, 25),
        (892878741, 64, 43),
        (694873649, 64, 37),
        (142443833, 64, 33),
        (848474627, 64, 57),
        (824105924, 64, 41),
        (170208024, 64, 52),
        (281387505, 64, 32),
        (610401323, 64, 50),
        (801015372, 64, 10),
        (143084570, 64, 49),
        (363464500, 64, 24),
        (698099024, 64, 37),
        (78547565, 64, 34),
        (146764659, 64, 49),
        (619817, 64, 35),
        (532704722, 64, 6),
        (1025900559, 64, 47),
        (689925184, 64, 37),
        (1065863364, 64, 1),
        (208285721, 64, 41),
        (130755951, 64, 63),
        (842391266, 64, 57),
        (168703447, 64, 52),
        (954017671, 64, 60),
        (443352346, 64, 58),
        (315096729, 64, 34),
        (849946216, 64, 57),
        (941622294, 64, 60),
        (681162505, 64, 52),
        (413056707, 64, 40),
        (187321319, 64, 54),
        (658719870, 64, 15),
        (162243863, 64, 51),
        (513207677, 64, 46),
        (558468452, 64, 33),
        (106512539, 64, 57),
        (0, 1024, 1),
        (1, 1024, 2),
        (2, 1024, 11),
        (3, 1024, 3),
        (4, 1024, 20),
        (5, 1024, 12),
        (6, 1024, 28),
        (7, 1024, 4),
        (8, 1024, 36),
        (9, 1024, 21),
        (10, 1024, 43),
        (11, 1024, 13),
        (12, 1024, 50),
        (13, 1024, 29),
        (14, 1024, 57),
        (15, 1024, 5),
        (16, 1024, 64),
        (17, 1024, 37),
        (18, 1024, 70),
        (19, 1024, 22),
        (20, 1024, 76),
        (21, 1024, 44),
        (22, 1024, 82),
        (23, 1024, 14),
        (24, 1024, 88),
        (25, 1024, 51),
        (26, 1024, 94),
        (27, 1024, 30),
        (28, 1024, 100),
        (29, 1024, 58),
        (30, 1024, 106),
        (31, 1024, 6),
        (32, 1024, 112),
        (33, 1024, 65),
        (34, 1024, 117),
        (35, 1024, 38),
        (36, 1024, 122),
        (37, 1024, 71),
        (38, 1024, 127),
        (39, 1024, 23),
        (40, 1024, 132),
        (41, 1024, 77),
        (42, 1024, 137),
        (43, 1024, 45),
        (44, 1024, 142),
        (45, 1024, 83),
        (46, 1024, 147),
        (47, 1024, 15),
        (48, 1024, 152),
        (49, 1024, 89),
        (50, 1024, 157),
        (51, 1024, 52),
        (52, 1024, 162),
        (53, 1024, 95),
        (54, 1024, 167),
        (55, 1024, 31),
        (56, 1024, 172),
        (57, 1024, 101),
        (58, 1024, 177),
        (59, 1024, 59),
        (60, 1024, 182),
        (61, 1024, 107),
        (62, 1024, 187),
        (63, 1024, 7),
        (64, 1024, 192),
        (65, 1024, 113),
        (66, 1024, 196),
        (67, 1024, 66),
        (68, 1024, 200),
        (69, 1024, 118),
        (70, 1024, 204),
        (71, 1024, 39),
        (72, 1024, 208),
        (73, 1024, 123),
        (74, 1024, 212),
        (75, 1024, 72),
        (76, 1024, 216),
        (77, 1024, 128),
        (78, 1024, 220),
        (79, 1024, 24),
        (80, 1024, 224),
        (81, 1024, 133),
        (82, 1024, 228),
        (83, 1024, 78),
        (84, 1024, 232),
        (85, 1024, 138),
        (86, 1024, 236),
        (87, 1024, 46),
        (88, 1024, 240),
        (89, 1024, 143),
        (90, 1024, 244),
        (91, 1024, 84),
        (92, 1024, 248),
        (93, 1024, 148),
        (94, 1024, 252),
        (95, 1024, 16),
        (96, 1024, 256),
        (97, 1024, 153),
        (98, 1024, 260),
        (99, 1024, 90),
        (717354021, 1024, 854),
        (1061650667, 1024, 1018),
        (946286476, 1024, 963),
        (784077896, 1024, 408),
        (491263, 1024, 58),
        (550290313, 1024, 774),
        (224766667, 1024, 685),
        (1069620869, 1024, 1022),
        (630311759, 1024, 557),
        (1013994432, 1024, 307),
        (396591248, 1024, 890),
        (629559425, 1024, 812),
        (799981516, 1024, 893),
        (592322119, 1024, 794),
        (410430189, 1024, 903),
        (729053692, 1024, 239),
        (630361478, 1024, 557),
        (796884249, 1024, 255),
        (166716594, 1024, 367),
        (413652244, 1024, 906),
        (726684926, 1024, 603),
        (271757669, 1024, 771),
        (795511698, 1024, 891),
        (105433556, 1024, 914),
        (878115723, 1024, 675),
        (830873852, 1024, 908),
        (550260202, 1024, 774),
        (986026652, 1024, 982),
        (117628829, 1024, 704),
        (147806606, 1024, 340),
        (732152370, 1024, 861),
        (704211524, 1024, 77),
        (718568663, 1024, 599),
        (889937879, 1024, 936),
        (252070889, 1024, 737),
        (776094449, 1024, 882),
        (602957303, 1024, 41),
        (812297694, 1024, 899),
        (850839392, 1024, 432),
        (121930838, 1024, 977),
        (217946253, 1024, 53),
        (927586281, 1024, 954),
        (937426313, 1024, 703),
        (226591751, 1024, 944),
        (272404799, 1024, 194),
        (398576445, 1024, 892),
        (826019350, 1024, 423),
        (77964601, 1024, 809),
        (542837249, 1024, 515),
        (494008192, 1024, 983),
        (621080892, 1024, 808),
        (339933393, 1024, 836),
        (365262088, 1024, 860),
        (341893848, 1024, 838),
        (167739021, 1024, 21),
        (98998899, 1024, 411),
        (729416111, 1024, 239),
        (254447594, 1024, 997),
        (550367865, 1024, 774),
        (732412360, 1024, 861),
        (422396446, 1024, 658),
        (399713351, 1024, 893),
        (734901635, 1024, 862),
        (737248710, 1024, 48),
        (892878741, 1024, 447),
        (694873649, 1024, 843),
        (142443833, 1024, 69),
        (848474627, 1024, 661),
        (824105924, 1024, 649),
        (170208024, 1024, 581),
        (281387505, 1024, 780),
        (610401323, 1024, 803),
        (801015372, 1024, 414),
        (143084570, 1024, 529),
        (363464500, 1024, 602),
        (698099024, 1024, 589),
        (78547565, 1024, 212),
        (146764659, 1024, 119),
        (619817, 1024, 559),
        (532704722, 1024, 1020),
        (1025900559, 1024, 1001),
        (689925184, 1024, 585),
        (1065863364, 1024, 1020),
        (208285721, 1024, 909),
        (130755951, 1024, 754),
        (842391266, 1024, 429),
        (168703447, 1024, 370),
        (954017671, 1024, 711),
        (443352346, 1024, 678),
        (315096729, 1024, 812),
        (849946216, 1024, 917),
        (941622294, 1024, 961),
        (681162505, 1024, 581),
        (413056707, 1024, 422),
        (187321319, 1024, 869),
        (658719870, 1024, 826),
        (162243863, 1024, 821),
        (513207677, 1024, 1001),
        (558468452, 1024, 778),
        (106512539, 1024, 918),
    ],
)
def test_pick_deposition_site_regression(
    rank: int,
    surface_size: int,
    expected_result: int,
):
    # for surface_size in 8, 32, 64, 1024:
    #     for rank in [
    #         *range(100),
    #         *map(int, np.random.RandomState(seed=1).randint(0, 2**30, 10**2)),
    #     ]:
    #         result = algo.pick_deposition_site(rank, surface_size)
    #         print(rank, surface_size, result)
    assert expected_result == algo.pick_deposition_site(rank, surface_size)
