\definecolor{C0}{HTML}{1F77B4}  % tab10[0]
\definecolor{C1}{HTML}{FF7F0E}  % tab10[1]
\definecolor{C2}{HTML}{2CA02C}  % tab10[2]
\definecolor{C3}{HTML}{D62728}  % tab10[3]
\definecolor{C4}{HTML}{9467BD}  % tab10[4]
\definecolor{C5}{HTML}{8C564B}  % tab10[5]
\definecolor{C6}{HTML}{E377C2}  % tab10[6]
\definecolor{C7}{HTML}{7F7F7F}  % tab10[7]
\definecolor{C8}{HTML}{BCBD22}  % tab10[8]
\definecolor{C9}{HTML}{17BECF}  % tab10[9]
\definecolor{C10}{HTML}{A1C9F4} % pastel[0]
\definecolor{C11}{HTML}{FFB482} % pastel[1]
\definecolor{C12}{HTML}{8DE5A1} % pastel[2]
\definecolor{C13}{HTML}{FF9F9B} % pastel[3]
\definecolor{C14}{HTML}{D0BBFF} % pastel[4]
\definecolor{C15}{HTML}{DEBB9B} % pastel[5]
\newcommand{\boxnum}[2]{%
  \begingroup
  \setlength{\fboxsep}{2pt}%  % padding inside the box
  \colorbox{#1}{\textcolor{white}{\large\bfseries #2}}%
  \endgroup
}

\begin{figure*}
  \centering

\begin{subfigure}{\linewidth}
  %------------- first (τ = 1) row ----------------------------
  \noindent
  % gray label column – twice as wide & twice as tall
  \fcolorbox{gray!3}{gray!3}{%
    \begin{minipage}[c][1.68in][c]{0.03\linewidth}
      \centering
      \rotatebox{90}{\shortstack{Meta-epoch $\colortau = 1$ \footnotesize(\@ Time $\colorT = 32$)\\~}}
    \end{minipage}}%
  \hspace{-0.8ex}{\vrule width 1pt}\hspace{-0.8ex}%
  % purple panel – picture + automatic purple fill on the right
  \fcolorbox{purple!5}{purple!5}{%
    \begin{minipage}[c][1.68in][c]{0.44\linewidth}
      \hspace{-1.5ex}
      \vspace{-2ex}
      \begin{tikzpicture}[>=Stealth,decoration={brace}]
        \node[inner sep=0pt] (imgA) {\includegraphics[trim={0 0.69cm 0 0},clip,height=1.30in]{binder-hanoi-strategy-small-epoch/binder/teeplots/hanoi-strategy-small-epoch/font.family=serif+hue=hanoi-value+viz=lolliplot+what=last-n-after+x=index+y=hanoi-value+ext=.pdf}};
        \draw[->] ($(imgA.east)+(0.15,1.20)$) -- ($(imgA.east)+(-0.34,1.20)$);
        \node[inner sep=2pt,right] at ($(imgA.east)+(0.15,1.20)$) {\small \; $1\times \boxnum{C5}{5}$};
        \draw[->] ($(imgA.east)+(0.15,0.80)$) -- ($(imgA.east)+(-0.34,0.80)$);
        \node[inner sep=2pt,right] at ($(imgA.east)+(0.15,0.80)$) {\small \; $1\times \boxnum{C4}{4}$};
        \draw[->] ($(imgA.east)+(0.15,0.40)$) -- ($(imgA.east)+(-0.34,0.40)$);
        \node[inner sep=2pt,right] at ($(imgA.east)+(0.15,0.40)$) {\small \; $2\times \boxnum{C3}{3}$};
        \draw[->] ($(imgA.east)+(0.15,0)$) -- ($(imgA.east)+(-0.34,0)$);
        \node[inner sep=2pt,right] at ($(imgA.east)+(0.15,0)$) {\small \; $4\times \boxnum{C2}{2}$};
        \draw[->] ($(imgA.east)+(0.15,-0.40)$) -- ($(imgA.east)+(-0.34,-0.40)$);
        \node[inner sep=2pt,right] at ($(imgA.east)+(0.15,-0.40)$) {\small \; $4\times \boxnum{C1}{1}$};
        \draw[->] ($(imgA.east)+(0.15,-0.80)$) -- ($(imgA.east)+(-0.34,-0.80)$);
        \node[inner sep=2pt,right] at ($(imgA.east)+(0.15,-0.80)$) {\small \; $4\times \boxnum{C0}{0}$};
        \draw[line width=1.4pt,decorate,decoration={brace,amplitude=4pt}] ($(imgA.east)+(0.3,1.50)$) -- ($(imgA.east)+(1.15,1.50)$)
          node[midway,anchor=south,yshift=0.19cm,align=center,xshift=-2.8cm] {\Large Keep up to $4$ most recent items of each \hv{}\\(If $<4$ items of \hv{} seen, keep all \hv{} items.)};
      \end{tikzpicture}
      \hspace*{\fill}%
    \end{minipage}}\\[-1ex]

  %------------- second (τ = 0) row ---------------------------
  \noindent
  \fcolorbox{gray!11}{gray!11}{%
    \begin{minipage}[c][1.68in][c]{0.03\linewidth}
      \centering
      \rotatebox{90}{\shortstack{Meta-epoch $\colortau = 0$ \footnotesize(\@ Time $\colorT = 16$)\\~}}
    \end{minipage}}%
  \hspace{-0.8ex}{\vrule width 1pt}\hspace{-0.8ex}%
  \fcolorbox{purple!11}{purple!11}{%
    \begin{minipage}[c][1.68in][c]{0.44\linewidth}
      \vspace{-1.3cm}
      \hspace{-1.5ex}
      \vspace{-4ex}
      \begin{tikzpicture}[>=Stealth,decoration={brace}]
        \node[inner sep=0pt] (imgB) {\includegraphics[trim={0 0.75cm 0 0},height=1.30in]{binder-hanoi-strategy-small-epoch/binder/teeplots/hanoi-strategy-small-epoch/font.family=serif+hue=hanoi-value+viz=lolliplot+what=last-n-before+x=index+xlim=32+y=hanoi-value+ext=.pdf}};
        \draw[->] ($(imgB.east)+(0.15,0.80)$) -- ($(imgB.east)+(-2.77,0.80)$);
        \node[inner sep=2pt,right] at ($(imgB.east)+(0.15,0.80)$) {\small \; $1\times \boxnum{C4}{4}$};
        \draw[->] ($(imgB.east)+(0.15,0.40)$) -- ($(imgB.east)+(-2.77,0.40)$);
        \node[inner sep=2pt,right] at ($(imgB.east)+(0.15,0.40)$) {\small \; $1\times \boxnum{C3}{3}$};
        \draw[->] ($(imgB.east)+(0.15,0)$) -- ($(imgB.east)+(-2.77,0)$);
        \node[inner sep=2pt,right] at ($(imgB.east)+(0.15,0)$) {\small \; $2\times \boxnum{C2}{2}$};
        \draw[->] ($(imgB.east)+(0.15,-0.40)$) -- ($(imgB.east)+(-2.77,-0.40)$);
        \node[inner sep=2pt,right] at ($(imgB.east)+(0.15,-0.40)$) {\small \; $4\times \boxnum{C1}{1}$};
        \draw[->] ($(imgB.east)+(0.15,-0.80)$) -- ($(imgB.east)+(-2.77,-0.80)$);
        \node[inner sep=2pt,right] at ($(imgB.east)+(0.15,-0.80)$) {\small \; $8\times \boxnum{C0}{0}$};
        \draw[line width=1.4pt,decorate,decoration={brace,amplitude=4pt}] ($(imgB.east)+(0.3,1.10)$) -- ($(imgB.east)+(1.15,1.10)$)
          node[midway,anchor=south,yshift=0.19cm,align=center,xshift=-2.8cm] {\Large Keep up to $8$ most recent items of each \hv{}\\(If $<8$ items of \hv{} seen, keep all \hv{} items.)};
      \end{tikzpicture}
      \vspace{-0.7cm}
      \hspace*{\fill}%
    \end{minipage}}

  \caption{\footnotesize last-$n$ \hv{} retention}
  \label{fig:hanoi-intuition:hv-retention}
\end{subfigure}

\vspace{1.5ex}

\begin{subfigure}{\linewidth}

  \begin{tikzpicture}

    % ---------- first (left) plot ----------
    \node[anchor=north west, inner sep=0] (X) at (0,0){%
      \includegraphics[height=3.283in,
                       trim={0 0.55in 8.06cm 0},clip]%
                      {binder-20a-tilted-eulerian-surface/binder/%
                       teeplots/20a/color-epoch-t=black+color-metaepoch-tau=black+%
                       color-site-k=black+font.family=serif+plotter=clear_ax+surface-size=16+%
                       swap-yaxes=True+symbol-color=black+%
                       viz=site-reservation-at-ranks-heatmap+ext=.pdf}};

      \fill[gray,fill opacity=0.12] ($(X.south west) - (-0.5cm, 0.2cm)$)
                       rectangle ($(X.south west) - (-1cm, -0.52cm)$);
      \fill[gray,fill opacity=0.055] ($(X.south west) - (-0.5cm, -1.22cm)$)
                       rectangle ($(X.south west) - (-1cm, -0.52cm)$);


                       % ---------- overlays for the first plot ----------
    \begin{scope}[x={(X.south east)},y={(X.north west)}]

      \fill[purple,fill opacity=0.11] ($(X.south west) - (-1cm, 0.2cm)$)
                       rectangle ($(X.south east) - (0.7cm, 0) + (0, 0.5cm)$);
      \fill[purple, fill opacity=0.052] ($(X.south west) - (-1cm,-0.5cm)$)
                       rectangle ($(X.south east) - (0.7cm, 0) + (0, 1.2cm)$);

      % annotation rows
      \node[text width=2in] at ($(X.south west) - (0.6cm, 0) + (4.52cm, 7.8cm)$) {%
      $1 \times \boxnum{C15}{15}\; \boxnum{C14}{14}\; \boxnum{C13}{13}\;  \boxnum{C12}{12}\; \boxnum{C11}{11}\; \boxnum{C10}{10}\;\;\;\;\;\rightarrow$

      $\;\;\;\;\;\;\boxnum{C9}{9}\; \boxnum{C8}{8}\; \boxnum{C7}{7}\; \boxnum{C6}{6}\; \boxnum{C5}{5}\; \boxnum{C4}{4}\; \boxnum{C3}{3}\; \boxnum{C2}{2}\; \boxnum{C1}{1}\; \boxnum{C0}{0}$};

      \node[text width=1.5in] at ($(X.south west) - (0.6cm, 0) + (4.2cm, 6.73cm)$) {%
      \Large Keep last $1$ seen item of each \hv{}
      };

      \node[text width=2in] at ($(X.south west) - (0.55cm, 0) + (4.18cm, 3.05cm)$) {%
        $1 \times \boxnum{C8}{8}\; \boxnum{C7}{7}\;$%
        \;
        $2 \times \boxnum{C6}{6}\; \boxnum{C5}{5}\; \boxnum{C4}{4}\;%
                 \boxnum{C3}{3}\; \boxnum{C2}{2}\; \boxnum{C1}{1}\;%
                 \boxnum{C0}{0}\;\rightarrow$};

      \node[text width=1.5in] at ($(X.south west) - (0.6cm, 0) + (4.2cm, 2.1cm)$) {%
      \Large Keep up to $2$ most recent items of each \hv{} \small (Keep all \hv{} items, if fewer.)
      };

      \node[text width=2in] at ($(X.south west) - (0.6cm, 0) + (4.65cm, 0.9cm)$) {%
        $1 \times \boxnum{C5}{5}\; \boxnum{C4}{4}\;$%
        \;
        $2 \times \boxnum{C3}{3}\;$%
        \;
        $4 \times \boxnum{C2}{2}\; \boxnum{C1}{1}\; \boxnum{C0}{0}\;\rightarrow$};

      \node[text width=2in] at ($(X.south west) - (0.6cm, 0) + (4.21cm, 0.19cm)$) {%
        \;
      $1 \times \boxnum{C4}{4}\; \boxnum{C3}{3}\;$%
        \;
        $2 \times \boxnum{C2}{2}\;$%
        \;
        $4 \times \boxnum{C1}{1}\;$%
        \;
        $8 \times \boxnum{C0}{0}\;\rightarrow$};

    \end{scope}

    % ---------- second (right) plot ----------
    \node[anchor=north west, inner sep=0] (Y)
         at ($(X.north east) - (0.7cm, 0) + (0,0)$){%
      \includegraphics[height=3.7in,
                       trim={1.4cm 0 0 0},clip]%
                      {binder-20a-tilted-eulerian-surface/binder/%
                       teeplots/20a/color-epoch-t=black+color-metaepoch-tau=black+%
                       color-site-k=black+font.family=serif+surface-size=16+swap-yaxes=True+%
                       symbol-color=black+viz=site-reservation-at-ranks-heatmap+%
                       ext=.pdf}};
    % (optional) you can add more TikZ annotations that refer to Y here
  \end{tikzpicture}

  \vspace{-2.5ex}

\caption{\footnotesize time course of buffer layout; time from bottom to top}
\label{fig:hanoi-intuition:buffer-layout}

\end{subfigure}
% \begin{minipage}[]{1.42\linewidth}
% \noindent\fcolorbox{white!100}{white!100}{%
% \begin{minipage}[b][0.2cm]{0.02\linewidth}
% \hspace{-0.5ex}%
% \rotatebox{90}{$~$}
% \end{minipage}}%
% \hspace{-1.5ex}%
% {\vrule width 1pt}%
% \noindent\fcolorbox{orange!2}{orange!2}{%
% \begin{minipage}[]{0.34\linewidth}
% \centering
% \hspace{-1.2ex}\begin{subfigure}[b]{\linewidth}
% \captionsetup{justification=centering}
% \vspace{-2ex}
% \caption{steady strategy\\ \footnotesize all data items of top $n$ hanoi values}
% \label{fig:hanoi-intuition-steady}
% \end{subfigure}%
% \end{minipage}}%
% \hspace{-1ex}%
% {\vrule width 1pt}%
% \noindent\fcolorbox{pink!3}{pink!3}{%
% \begin{minipage}[]{0.31\linewidth}
% \centering
% \hspace{-1.2ex}\begin{subfigure}[b]{\linewidth}
% \captionsetup{justification=centering}
% \vspace{-2ex}
% \caption{stretched strategy\\ \footnotesize first $n$ data items of all hanoi values}
% \label{fig:hanoi-intuition-stretched}
% \end{subfigure}%
% \end{minipage}}%
% \hspace{-1ex}%
% {\vrule width 1pt}%
% \noindent\fcolorbox{purple!3}{purple!3}{%
% \begin{minipage}[]{0.31\linewidth}
% \centering
% \hspace{-1.2ex}\begin{subfigure}[b]{\linewidth}
% \captionsetup{justification=centering}
% \vspace{-2ex}
% \caption{tilted strategy\\ \footnotesize last $n$ data items of all hanoi values}
% \label{fig:hanoi-intuition-tilted}
% \end{subfigure}%
% \end{minipage}\hspace{-1ex}}%
% \end{minipage}
% \vspace{-0.1in}
\caption{%
  \textbf{Tilted-generalized ring buffer strategy.}
  \footnotesize
  Data retention is prioritized based on ``hanoi value'' (\hv) of arrival time $\colorT$ (``lollipop'' bars in upper panel).
  To achieve tilted coverage, our proposed strategy maintains the set of $n$ most-recent items for each \hv{} (green boxes in upper panel).
  As time ``epochs'' elapse, corresponding to arrival of progressively higher \hv 's, per-\hv{} $n$ shrinks.
  Lower panel shows epoch-by-epoch storage layout of sites ``reserved'' to store items of each \hv{} set, for buffer size $\colorS=16$.
  (For within-epoch detail of individual data items, see Figure \ref{fig:hsurf-tilted-implementation}.)
  In each successive ``meta-epoch'' (dashed lines) $n$ is halved across low \hv 's in a rolling fashion to store newly-arrived high-\hv items.
  Note nested composition of consecutive-\hv ``segments'' (solid lines); design is described in Figure \ref{fig:hsurf-stretched-intuition}.
  }
\label{fig:hanoi-intuition}
\end{figure*}
