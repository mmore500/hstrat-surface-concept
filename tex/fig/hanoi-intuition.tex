\usetikzlibrary{arrows.meta}

% ------------------ GLOBAL SCALE VARIABLES ---------------------------------
\newcommand{\XL}{0.57} % left  panel overall x-scale
\newcommand{\YL}{0.545} % left  panel y-scale (1 = unchanged)
\newcommand{\XR}{0.879} % right panel overall x-scale
\newcommand{\YR}{0.879}     % right panel y-scale (1 = unchanged)

% ------------------ colours & helpers --------------------------------------
\definecolor{C0}{HTML}{1F77B4}\definecolor{C1}{HTML}{FF7F0E}
\definecolor{C2}{HTML}{2CA02C}\definecolor{C3}{HTML}{D62728}
\definecolor{C4}{HTML}{9467BD}\definecolor{C5}{HTML}{8C564B}
\definecolor{C6}{HTML}{E377C2}\definecolor{C7}{HTML}{7F7F7F}
\definecolor{C8}{HTML}{BCBD22}\definecolor{C9}{HTML}{17BECF}
\definecolor{C10}{HTML}{A1C9F4}\definecolor{C11}{HTML}{FFB482}
\definecolor{C12}{HTML}{8DE5A1}\definecolor{C13}{HTML}{FF9F9B}
\definecolor{C14}{HTML}{D0BBFF}\definecolor{C15}{HTML}{DEBB9B}

\newcommand{\boxnum}[2]{\begingroup\setlength{\fboxsep}{2pt}%
  \colorbox{#1}{\textcolor{white}{\large\bfseries #2}}\endgroup}

\tikzset{
  whitevert/.style={white,line width=2.5pt},
  whitebar/.style={white,line width=2.5pt},
  colorvert/.style={line width=.9pt},
  colorbar/.style={line width=.9pt}
}

\begin{figure*}
  \centering
% ===================== TOP PANEL ============================
\begin{minipage}{0.355\linewidth}
\begingroup
\scalebox{\XL}[\YL]{%
\begin{minipage}{\linewidth}

  \fcolorbox{gray!3}{gray!3}{%
    \begin{minipage}[c][0.15in][c]{\linewidth}\centering
      \Large Meta-epoch $\colortau = 1$ \normalsize (@ Time $\colorT = 32$)
    \end{minipage}}\\[-0.25ex]
  \fcolorbox{purple!5}{purple!5}{%
    \begin{minipage}[c][2.4in][c]{\linewidth}
      \hspace{-2ex}\vspace{0ex}
      \begin{tikzpicture}[decoration={brace}]
        \node[inner sep=0pt] (imgA)
          {\includegraphics[trim={0 0.69cm 0 0},clip,height=1.30in]{binder-hanoi-strategy-small-epoch/binder/teeplots/hanoi-strategy-small-epoch/font.family=serif+hue=hanoi-value+viz=lolliplot+what=last-n-after+x=index+y=hanoi-value+ext=.pdf}};
        \begin{scope}[yshift=0.05cm]
        \foreach \i/\mult/\col/\num in {0/1×/{C5}/5,1/1×/{C4}/4,2/2×/{C3}/3,
                                        3/4×/{C2}/2,4/4×/{C1}/1,5/4×/{C0}/0}{
          \pgfmathsetmacro\X{-3.98+0.648*\i}
          \pgfmathsetmacro\BoxY{2.55-0.12*\i}
          \pgfmathsetmacro\MultY{\BoxY+0.34}
          \pgfmathsetmacro\Top{\BoxY-0.05}
          \pgfmathsetmacro\NewBot{1.20-0.40*\i+0.15}
          \draw[whitevert] ($(imgA.east)+(\X,\Top)$)--($(imgA.east)+(\X,\NewBot)$);
          \draw[whitebar]  ($(imgA.east)+(\X,\NewBot)$)++(-0.105,0)--++(0.21,0);
          \draw[\col,colorvert]($(imgA.east)+(\X,\Top)$)--($(imgA.east)+(\X,\NewBot)$);
          \draw[\col,colorbar] ($(imgA.east)+(\X,\NewBot)$)++(-0.085,0)--++(0.17,0);
          \node at ($(imgA.east)+(\X,\MultY)$) {\normalsize \mult};
          \node at ($(imgA.east)+(\X,\BoxY)$)  {\small $\boxnum{\col}{\num}$};}
        \draw[line width=1.4pt,decorate,decoration={brace,amplitude=4pt}]
          ($(imgA.east)+(-4.21,3.20)$)--($(imgA.east)+(-0.37,3.20)$)
          node[anchor=south east,yshift=0.19cm,align=center]{\Large Keep $4$ most recent items of each \hv{}\\\normalsize (If $<4$ items of \hv{} seen, keep all \hv{} items.)};
        \end{scope}
      \end{tikzpicture}\hspace*{\fill}\end{minipage}}\\[0.2em]

      \newsavebox{\bindertrim}
      \sbox{\bindertrim}{\includegraphics[trim={0 0.75cm 0 0},clip,height=1.30in]{binder-hanoi-strategy-small-epoch/binder/teeplots/hanoi-strategy-small-epoch/font.family=serif+hue=hanoi-value+viz=lolliplot+what=last-n-before+x=index+xlim=32+y=hanoi-value+ext=.pdf}}
      \def\Shift{0.29}

      \fcolorbox{gray!11}{gray!11}{%
        \begin{minipage}[c][0.15in][c]{\linewidth}\centering
          \Large Meta-epoch $\colortau = 0$ \normalsize (@ Time $\colorT = 16$)
        \end{minipage}}\\[-0.25ex]
      \fcolorbox{purple!11}{purple!11}{%
        \begin{minipage}[c][2.3in][c]{\linewidth}
          \vspace{-1.3cm}\hspace{-2ex}\vspace{-6ex}
          \begin{tikzpicture}[decoration={brace}]
            \node[inner sep=0pt] (imgB)
              {\includegraphics[trim={0 0 0 0},clip,width=\wd\bindertrim]{binder-hanoi-strategy-small-epoch/binder/teeplots/hanoi-strategy-small-epoch/font.family=serif+hue=hanoi-value+viz=lolliplot+what=last-n-before+x=index+xlim=32+y=hanoi-value+ext=.pdf}};
            \foreach \i/\mult/\col/\num in {0/1×/{C4}/4,1/1×/{C3}/3,2/2×/{C2}/2,
                                            3/4×/{C1}/1,4/8×/{C0}/0}{
              \pgfmathsetmacro\X{-4.584+0.351*\i}
              \pgfmathsetmacro\BoxY{2.03-0.12*\i+\Shift}
              \pgfmathsetmacro\MultY{\BoxY+0.34}
              \pgfmathsetmacro\Top{\BoxY-0.05}
              \pgfmathsetmacro\NewBot{0.95-0.40*\i+\Shift}
              \draw[whitevert]($(imgB.east)+(\X,\Top)$)--($(imgB.east)+(\X,\NewBot)$);
              \draw[whitebar] ($(imgB.east)+(\X,\NewBot)$)++(-0.105,0)--++(0.21,0);
              \draw[\col,colorvert]($(imgB.east)+(\X,\Top)$)--($(imgB.east)+(\X,\NewBot)$);
              \draw[\col,colorbar] ($(imgB.east)+(\X,\NewBot)$)++(-0.085,0)--++(0.17,0);
              \node at ($(imgB.east)+(\X,\MultY)$) {\normalsize \mult};
              \node at ($(imgB.east)+(\X,\BoxY)$)  {\small $\boxnum{\col}{\num}$};}
            \draw[line width=1.4pt,decorate,decoration={brace,amplitude=4pt}]
              ($(imgB.east)+(-4.78,3.45 - 0.45)$)--($(imgB.east)+(-2.88,3.45 - 0.45)$);
            \node[anchor=south west,align=center] at ($(imgB.east)+(-6.28,3.45 - 0.45)+(0,0.19)$)
                  {\Large Keep $8$ most recent items of each \hv{}\\\normalsize(If $<8$ items of \hv{} seen, keep all \hv{} items.)};
          \end{tikzpicture}\vspace{-0.7cm}\hspace*{\fill}\end{minipage}}

          \vspace{6ex}
\end{minipage}}%
\endgroup

\end{minipage}%
\begin{minipage}{0.91\linewidth}
\hspace{-0.17\textwidth}%
\begingroup
\scalebox{\XR}[\YR]{%
\begin{minipage}{\linewidth}
  \hspace{-0.25cm}
  \begin{tikzpicture}

    % ---------- first (left) plot ----------
    \node[anchor=north west, inner sep=0] at (0,0){%
      \includegraphics[height=3.283in - 1.3cm,
                       trim={0.25cm 0.55in 16.0cm 1.3cm},clip]%
                      {binder-20a-tilted-eulerian-surface/binder/%
                       teeplots/20a/color-epoch-t=black+color-metaepoch-tau=black+%
                       color-site-k=black+font.family=serif+plotter=clear_ax+surface-size=16+%
                       swap-yaxes=True+symbol-color=black+%
                       viz=site-reservation-at-ranks-heatmap+ext=.pdf}};
    \node[anchor=north west, inner sep=0] at (0,0){%
      \includegraphics[height=3.283in,
                       trim={0.8cm 0.55in 9.06cm 0},clip]%
                      {binder-20a-tilted-eulerian-surface/binder/%
                       teeplots/20a/color-epoch-t=black+color-metaepoch-tau=black+%
                       color-site-k=black+font.family=serif+plotter=clear_ax+surface-size=16+%
                       swap-yaxes=True+symbol-color=black+%
                       viz=site-reservation-at-ranks-heatmap+ext=.pdf}};
    \node[anchor=north west, inner sep=0, opacity=0.0] (X) at (-0.6cm,0){%
      \includegraphics[height=3.283in,
                       trim={0cm 0.55in 9.06cm 0},clip]%
                      {binder-20a-tilted-eulerian-surface/binder/%
                       teeplots/20a/color-epoch-t=black+color-metaepoch-tau=black+%
                       color-site-k=black+font.family=serif+plotter=clear_ax+surface-size=16+%
                       swap-yaxes=True+symbol-color=black+%
                       viz=site-reservation-at-ranks-heatmap+ext=.pdf}};
      \fill[gray,fill opacity=0.12] ($(X.south west) - (-0.5cm, 0.2cm)$)
                       rectangle ($(X.south west) - (-1cm, -0.52cm)$);
      \fill[gray,fill opacity=0.055] ($(X.south west) - (-0.5cm, -1.22cm)$)
                       rectangle ($(X.south west) - (-1cm, -0.52cm)$);

    \begin{scope}[x={(X.south east)},y={(X.north west)}]
      \fill[purple,fill opacity=0.11] ($(X.south west) - (-1cm, 0.2cm)$)
                       rectangle ($(X.south east) - (0.7cm, 0) + (0.6cm, 0.5cm)$);
      \fill[purple, fill opacity=0.052] ($(X.south west) - (-1cm,-0.5cm)$)
                       rectangle ($(X.south east) - (0.7cm, 0) + (0.6cm, 1.2cm)$);

      \node[text width=2in] at ($(X.south west) - (0.6cm, 0) + (4.37cm, 7.8cm)$) {%
      $1 \times \boxnum{C15}{15}\; \boxnum{C14}{14}\; \boxnum{C13}{13}\;  \boxnum{C12}{12}\; \boxnum{C11}{11}\; \boxnum{C10}{10}\;\boxnum{C9}{9}\;\rightarrow$

      $\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\; \boxnum{C8}{8}\; \boxnum{C7}{7}\; \boxnum{C6}{6}\; \boxnum{C5}{5}\; \boxnum{C4}{4}\; \boxnum{C3}{3}\; \boxnum{C2}{2}\; \boxnum{C1}{1}\; \boxnum{C0}{0}$};

      \node[text width=1.5in] at ($(X.south west) - (0.6cm, 0) + (4.1cm, 6.88cm)$) {%
      \Large Keep $1$ most recent item of each \hv{}};

      \node[text width=2in] at ($(X.south west) - (0.55cm, 0) + (4.16cm, 3.05cm)$) {%
        $1 \times \boxnum{C8}{8}\; \boxnum{C7}{7}\;$%
        \;
        $2 \times \boxnum{C6}{6}\; \boxnum{C5}{5}\; \boxnum{C4}{4}\;%
                 \boxnum{C3}{3}\; \boxnum{C2}{2}\; \boxnum{C1}{1}\;%
                 \boxnum{C0}{0}\;\rightarrow$};

      \node[text width=1.5in] at ($(X.south west) - (0.6cm, 0) + (4.1cm, 2.1cm)$) {%
      \Large Keep $2$ most recent items of each \hv{}\\ \small (Keep all \hv{} items, if fewer.)};

      \node[text width=2in] at ($(X.south west) - (0.6cm, 0) + (4.65cm, 0.9cm)$) {%
        $1 \times \boxnum{C5}{5}\; \boxnum{C4}{4}\;$%
        \;
        $2 \times \boxnum{C3}{3}\;$%
        \;
        $4 \times \boxnum{C2}{2}\; \boxnum{C1}{1}\; \boxnum{C0}{0}\;\rightarrow$};

      \node[text width=2in] at ($(X.south west) - (0.6cm, 0) + (4.21cm, 0.19cm)$) {%
        \;
      $1 \times \boxnum{C4}{4}\; \boxnum{C3}{3}\;$%
        \;
        $2 \times \boxnum{C2}{2}\;$%
        \;
        $4 \times \boxnum{C1}{1}\;$%
        \;
        $8 \times \boxnum{C0}{0}\;\rightarrow$};
    \end{scope}

    % ---------- second (right) plot ----------
    \node[anchor=north west, inner sep=0] (Y)
         at ($(X.north east) - (0.7cm, 0) + (0.6cm,0)$){%
      \includegraphics[height=3.7in,
                        width=4.4in,
                       trim={1.4cm 0 0 0},clip]%
                      {binder-20a-tilted-eulerian-surface/binder/%
                       teeplots/20a/color-epoch-t=black+color-metaepoch-tau=black+%
                       color-site-k=black+font.family=serif+surface-size=16+swap-yaxes=True+%
                       symbol-color=black+viz=site-reservation-at-ranks-heatmap+%
                       ext=.pdf}};
  \end{tikzpicture}

  \vspace{-2.5ex}
\end{minipage}}%
\endgroup

\end{minipage}%

\begin{subfigure}{0.2\textwidth}
  \caption{\footnotesize last-$n$ \hv{} retention}
  \label{fig:hanoi-intuition:last-n}
\end{subfigure}%
\begin{subfigure}{0.8\textwidth}
  \caption{\footnotesize time course of buffer layout; time from bottom to top}
  \label{fig:hanoi-intuition:buffer-layout}
\end{subfigure}%

% \begin{minipage}[]{1.42\linewidth}
% \noindent\fcolorbox{white!100}{white!100}{%
% \begin{minipage}[b][0.2cm]{0.02\linewidth}
% \hspace{-0.5ex}%
% \rotatebox{90}{$~$}
% \end{minipage}}%
% \hspace{-1.5ex}%
% {\vrule width 1pt}%
% \noindent\fcolorbox{orange!2}{orange!2}{%
% \begin{minipage}[]{0.34\linewidth}
% \centering
% \hspace{-1.2ex}\begin{subfigure}[b]{\linewidth}
% \captionsetup{justification=centering}
% \vspace{-2ex}
% \caption{steady strategy\\ \footnotesize all data items of top $n$ hanoi values}
% \label{fig:hanoi-intuition-steady}
% \end{subfigure}%
% \end{minipage}}%
% \hspace{-1ex}%
% {\vrule width 1pt}%
% \noindent\fcolorbox{pink!3}{pink!3}{%
% \begin{minipage}[]{0.31\linewidth}
% \centering
% \hspace{-1.2ex}\begin{subfigure}[b]{\linewidth}
% \captionsetup{justification=centering}
% \vspace{-2ex}
% \caption{stretched strategy\\ \footnotesize first $n$ data items of all hanoi values}
% \label{fig:hanoi-intuition-stretched}
% \end{subfigure}%
% \end{minipage}}%
% \hspace{-1ex}%
% {\vrule width 1pt}%
% \noindent\fcolorbox{purple!3}{purple!3}{%
% \begin{minipage}[]{0.31\linewidth}
% \centering
% \hspace{-1.2ex}\begin{subfigure}[b]{\linewidth}
% \captionsetup{justification=centering}
% \vspace{-2ex}
% \caption{tilted strategy\\ \footnotesize last $n$ data items of all hanoi values}
% \label{fig:hanoi-intuition-tilted}
% \end{subfigure}%
% \end{minipage}\hspace{-1ex}}%
% \end{minipage}
% \vspace{-0.1in}
\caption{%
  \textbf{Tilted-generalized ring buffer strategy.}
  \footnotesize
  Data retention is prioritized based on ``hanoi value'' (\hv) of arrival time $\colorT$ (``lollipop'' bars in upper panel).
  To achieve tilted coverage, our proposed strategy maintains the set of $n$ most-recent items for each \hv{} (green boxes in upper panel).
  As time ``epochs'' elapse, corresponding to arrival of progressively higher \hv 's, per-\hv{} $n$ shrinks.
  Lower panel shows epoch-by-epoch storage layout of sites ``reserved'' to store items of each \hv{} set, for buffer size $\colorS=16$.
  (For within-epoch detail of individual data items, see Figure \ref{fig:hsurf-tilted-implementation}.)
  In each successive ``meta-epoch'' $n$ is halved across low \hv{} 's in a rolling fashion to store newly-arrived high-\hv items.
  Note nested composition of consecutive-\hv ``segments'' (solid lines); design is described in Figure \ref{fig:hsurf-stretched-intuition}.
  }
\label{fig:hanoi-intuition}
\end{figure*}
