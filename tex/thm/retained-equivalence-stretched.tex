\begin{lemma}[Stretched Algorithm Retained Ingest Times]
\label{thm:retained-equivalence-stretched}
If the first $n$ data items $\colorH(\colorTbar) = \colorh$ for each h.v. $\colorh$ are retained, then we are guaranteed to have retained
\begin{align*}
\colorTbar
&\in
\{
  j'2^{\colorh'} - 1
  :
  j' \in 1,2,\,\ldots,2n
  \text{ and }
  \colorh' \in \mathbb{N}
\}.
\end{align*}
Note that, although this formulation nominally includes $\colorTbar > \colorT$, an extension filtering $\colorTbar \in 0,1,\,\ldots,\colorT$ follows trivially.
\end{lemma}
\begin{proof}

Recall that the $j$th instance of hanoi value $\colorh$ appears at ingest time
\begin{align*}
\colorTbar
&= j2^{\colorh + 1} + 2^{\colorh} - 1,
\end{align*}
indexed from $j=0$.

The set of retained data items can be denoted
\begin{align*}
\mathsf{have\_retained} =
\{
  j2^{\colorh + 1} + 2^{\colorh} - 1
  :
  j \in 0,1,\,\ldots,n-1
  \text{ and }
  \colorh \in \mathbb{N}
\}.
\end{align*}

We will show $\mathsf{have\_retained}$ equivalent to,
\begin{align*}
\mathsf{want\_retained} =
\{
  j'2^{\colorh'} - 1
  :
  j' \in 1,2,\,\ldots,2n
  \text{ and }
  \colorh' \in \mathbb{N}
\}.
\end{align*}

\begin{proofpart}[$\mathsf{have\_retained} \subseteq \mathsf{want\_retained}$]
Suppose $\colorTbar \in \mathsf{have\_retained}$.
Then $\exists j \in \{0,1,\,\ldots,n-1\}$ and $\colorh \in \mathbb{N}$ such that
\begin{align*}
\colorTbar
&= j2^{\colorh + 1} + 2^{\colorh} - 1\\
&= (2j + 1)2^{\colorh} - 1.
\end{align*}
Noting $2j + 1 \in 1,2,\,\ldots,2n$ gives $\mathsf{have\_retained} \stackrel{\checkmark}{\subseteq} \mathsf{want\_retained}$.
\end{proofpart}

\begin{proofpart}[$\mathsf{want\_retained} \subseteq \mathsf{have\_retained}$]
Suppose $\colorTbar \in \mathsf{want\_retained}$.
Then $\exists j'\in\{1,2,\,\ldots,2n\}$ and $\colorh' \in \mathbb{N}$ such that
\begin{align*}
\colorTbar
&= j'2^{\colorh'} - 1.
\end{align*}

First, where $j' \in \{1,2,\,\ldots,2n-1\}$,
\begin{align*}
\colorTbar
&= \frac{j'-1}{2} 2^{\colorh' + 1} + 2^{\colorh'} - 1.
\end{align*}
for $j' \in \{1, 3, \,\ldots 2n-1\}$.
Because $\frac{j'-1}{2} \in 0, 1, \, \ldots, n - 1$ here, $\mathsf{want\_retained} \stackrel{\checkmark}{\subseteq} \mathsf{have\_retained}$.

In the case that $j' \bmod 2 = 0$,
\begin{align*}
\colorTbar
&= j'2^{\colorh'} - 1\\
&= \frac{j'}{2}2^{\colorh' + 1} - 1.
\end{align*}

Recalling that $\colorH(j'/2 - 1) = \log_2 \max\{ i \in 2^{\mathbb{N}} : i \bmod j'/2 = 0 \}$,
\begin{align*}
\\
\colorTbar
&=
\eqnmarkbox[WildStrawberry]{inoddintegers}{
  \frac{j'/2}{2^{\colorH(j'/2 - 1)}}
}
2^{\colorh'} - 1\\
&= \Big(\frac{j'/2}{2^{\colorH(j'/2 - 1)}} - 1\Big) 2^{\colorh'} + 2^{\colorh'} - 1\\
&=
\eqnmarkbox[WildStrawberry]{inintegers}{\Big(
  \frac{
    \frac{j'/2}{2^{\colorH(j'/2 - 1)}} - 1
  }{2}
\Big)}
2^{\colorh' + 1} + 2^{\colorh'} - 1
\\
\end{align*}
\annotate[yshift=1em]{above,right}{inoddintegers}{$\in 1,3,5,\ldots$}
\annotate[yshift=0em]{below,right}{inintegers}{$\in \mathbb{N}$}
for $j' \in \{2, 4, \,\ldots 2n\}$.
Because $j'/2 \in \{1, 2, \, \ldots, n\}$,
\begin{align*}
\Big(\frac{(j'/2)/(2^{\colorH(j'/2 - 1)}) - 1}{2}\Big)
\stackrel{\checkmark}{\leq} \frac{n - 1}{2}).
\end{align*}
Thus, $\mathsf{want\_retained} \stackrel{\checkmark}{\subseteq} \mathsf{have\_retained}$ here, too.
\end{proofpart}
\end{proof}
