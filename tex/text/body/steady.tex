\section{Steady Algorithm} \label{sec:steady}

The steady criterion seeks to retain data items from time points evenly spread across observed history.
The criterion can be formulated as minimization of the worst gap size between retained data items.
This section presents a stream curation algorithm designed to support the steady criterion.

The mechanism of the proposed algorithm revolves around placing and retaining data items according to the hanoi value $\colorh$ of their sequence index $\colorT$.
For instance, discarding items with $\colorH(\colorT) = 0$ drops every other item, and increases gap size to 1.
Subsequently, removing items with $\colorH(\colorT) = 1$ again drops every other item and increases gap size to 3.
Pruning according to hanoi value provides a well-behaved transition to increase gap size.

Given that only $\colorS$ data items can be retained, our goal is to maintain all items $\colorT_y$ with high hanoi value $\colorH(\colorT_y)$ by repeatedly discarding items $\colorT_x$ with lowest hanoi value $\colorH(\colorT_x)$.
It turns out that, at each epoch $\colort$, we should keep all items with all items $\colorT$ with $\colorH(\colorT) \geq \colort$.
All items with $\colorH(\colorT) = \colort - 1$ are replaced by new items with higher hanoi value.
Note that, under this scheme, there are never retained items $\colorT$ such that $\colorH(\colorT) < \colort - 1$.

The remainder of the section examines how to arrange data item placement to enact the above hanoi value strategy.
We first detail the conceptual mechanism of the algorithm in managing buffer layout.
We subsequently justify the correctness and viability of aspects of the mechanism.
Then, we prove a lower bound of the performance of the algorithm in upholding the steady criterion.

\subsection{Mechanism}

\input{fig/hsurf-steady-intuition}

\subsection{Justification}

Let xj bj be the functions that give position for XXXX at time $T$.
We do not provide formal, closed-form definitions of them here but they can be computed in $\mathcal{O}(1)$ time with availability of binary operators (e.g., bit mask, bit shift, bitwise logical operators).


Suppose surface size $S = 2^s$ at rank $R$, with $r = \left\lceil \log_2 R \right\rceil$.
Note that $2 \times R \leq 2^r$.
In order for the steady algorithm to work, we need to have all values with hanoi value greater than or equal to
\begin{align*}
\max(r - s, 0)
\end{align*}

Recall that the distance between hanoi value instances is $2^{h + 1}$ and the distance between a hanoi value and a greater or equal hanoi value is $2^h$.
If we have $h = \max (r - s, 0)$, then gap size is at most $2^{\max(r - s, 0)}$.
The ideal gap size would be $\max( \left\lceil R / S \right\rceil, 1)$.

Can we bound the our bound on gap size is at most twice the ideal gap size?
\begin{align*}
\frac{
  2^{\max(r - s, 0)}
}{
  \max(\left\lceil R / S \right\rceil, 1)
}
&=
\frac{
  \max(2^r / 2^s, 1)
}{
  \max(\left\lceil R / S \right\rceil, 1)
} \\
&=
\frac{
  \max(2^r / S, 1)
}{
  \max(\left\lceil R / S \right\rceil, 1)
} \\
&\leq
\frac{
  \max(2R / S, 1)
}{
  \max(\left\lceil R / S \right\rceil, 1)
} \\
&\stackrel{\checkmark}{\leq} 2.
\end{align*}

We will have seen 1 of hv $r - 1$, 2 of hv $r - 2$, 4 of hv $r - 4$, and $2 ^ {s - 1}$ of hv $\max(r - s, 0)$.
In general, we will have seen $\left\lfloor 2 ^ (r - h) \right\rfloor$ instances of hanoi value $h$ by epoch $r$.
Recall $\sum_{i = 0}^{q} 2^i = 2 ^ {q + 1} - 1$.
Do we have enough space?
\begin{align*}
\sum_{i = 0}^{(r - 1) - \max(r - s, 0)} 2 ^ i \\
&= \sum_{i = 0}^{\min(r - 1, s - 1)} 2 ^ i \\
&\leq \sum_{i = 0}^{s - 1} 2 ^ i \\
&\leq 2^s - 1\\
&\stackrel{\checkmark}{\leq} 2^s
\end{align*}

Need to prove:
\begin{itemize}
\item the number of reservation slots in $j$th reservation equals the number of hanoi value instances observed during any window where $r = k$.
\item note, because we always fill completely we will therefore drop instances of hanoi value $r - s - 1$.
\item that hanoi value $r - s - 1$ is in the $h \mod n$th slot
\end{itemize}

The hanoi value $h = r - j$ is placed in the $j$th reservation during epoch $r$.
The $j$th reservation has $s - j$ slot size.
So, at epoch $r$ in reservation $j$ the hanoi value $h(j, r)$ will overwrite hanoi value
\begin{align*}
h(j, r) - (s - j) - 1 \\
&= (r - j) - (s - j) - 1 \\
&\stackrel{\checkmark}{=} r - s - 1.
\end{align*}

The $j$th reservation has $\max(1, 2^{j - 1})$ slots.
The number of new observations of hanoi value during epoch $r$ is $h$ is $\# h(r) -  \# h(r - 1)$.
This is
\begin{align*}
\left\lfloor 2 ^ {r - h} \right\rfloor - \left\lfloor 2 ^ {r - h - 1} \right\rfloor \\
&= \left\lfloor 2 ^{r - (r - j)} \right\rfloor - \left\lfloor 2 ^ {r - (r - j) - 1} \right\rfloor \\
&= 2^j - \left\lfloor 2 ^ {j - 1} \right\rfloor \\
&= \min(2^j - 2^{j - 1}, 1) \\
&= \min(2 \times 2^{j - 1} - 2^{j - 1}, 1) \\
&\stackrel{\checkmark}{=} \min(2^{j - 1}, 1).
\end{align*}


\subsection{Criterion Satisfaction}

Take buffer size $\colorS$ at time $\colorT$.
At any one point in time, the best possible coverage is $\left\lceil \colorT / \colorS \right\rceil$.
The proposed curation algorithm achieves no worse than this by a constant factor.

\begin{theorem}[Steady Algorithm Worst-case Gap Size]
\label{thm:steady-gap-size}
Under the steady curation algorithm, no gap size exceeds $\left\lceil 2 \colorT / \colorS \right\rceil$.  %TODO check this
\end{theorem}
\begin{proof}
TODO
\end{proof}
