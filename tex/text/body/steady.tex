\section{Steady Algorithm} \label{sec:steady}

The steady criterion seeks to retain data items from time points evenly spread across observed history.
The criterion can be formulated as minimization of the largest gap size between retained data items.
For a buffer size $\colorS$ and time elapsed $\colorT$, maximum gap size can be bounded at best $\left\lceil \colorT / \colorS \right\rceil$.
This section presents a stream curation algorithm designed to support the steady criterion, achieving maximum gap size no worse than $2\left\lceil \colorT / \colorS \right\rceil$.

Figure \ref{fig:hanoi-intuition-steady} shows the proposed algorithm's core mechanism, which revolves around placing and retaining data items according to the hanoi value of their sequence index $\colorH(\colorTbar)$.
Keeping data items with hanoi value $\colorh > n$ produces gap sizes at most $\colorg \leq 2^n - 1$.
For intuition, imagine discarding items with $\colorH(\colorTbar) = 0$.
This drops every other item, and results in gap size to $\colorg \leq 1$.
Imagine subsequently removing items with $\colorH(\colorTbar) = 1$.
This again drops every other item, and increases gap size to $\colorg \leq 3$.
Pruning according to hanoi value thus provides a well-behaved transition to gracefully increase gap size while keeping even spacing.

Our goal is thus to maintain all items $\colorTbar_y$ with hanoi value $\colorH(\colorTbar_y)$ above some threshold $n(\colorT)$ by repeatedly discarding items $\colorTbar_x$ with lowest hanoi value $\colorH(\colorTbar_x) = n(\colorT)$.
To fill available buffer space $\colorS$, it turns out that, at each epoch $\colort$, we should keep all items with all items $\colorTbar$ with h.v. equal to or greater than the current epoch, $\colorH(\colorT) \geq \colort$.

\begin{lemma}[Data items with h.v. greater than or equal to current epoch.]
At any time $\colorT$ in epoch $\colort$, sufficient buffer space exists to store all data items with h.v. $\colorh \geq \colort$.
That is, $\left| \{\colorTbar \in \{0, \ldots, \colorT \} \ni \colorH(\colorTbar) \geq \colort \} \right| \leq \colorS$.
\end{lemma}

\begin{proof}
Because counts of encountered h.v.'s increase with time, it is sufficient to consider just $\max\{\colorT \in \colort\} = 2^{\colors} - 2$.
Recall that h.v. $\colorh $is encountered for the first time at time $\colorT = 2^{\colorh} - 1$.
So, h.v. $\colorh = \colors + \colort$ is encountered at $\colorT = 2^{\colors + \colort} - 1$.
At that time, there are $\colors$ distinct hanoi values $\colorh$ such that $\colort \leq \colorh \leq \colors + \colort$.
Summing h.v. data item counts and subtracting away $\colorh = \colors + \colort$ (which lies one time point beyond epoch $\colort$) gives
\begin{align*}
\left| \{\colorTbar \in \{0, \ldots, 2^{\colors} - 2 \} \ni \colorH(\colorTbar) \geq \colort \} \right|
&= \left| \{\colorTbar \in \{0, \ldots, 2^{\colors} - 1 \} \ni \colorH(\colorTbar) \geq \colort \} \right| - 1\\
&= 1 + \sum_{i=1}^{\colors} 2^{i - 1} - 1 = 2^{\colors} - 1 = \colorS - 1\\
&\stackrel{\checkmark}{\leq} S.
\end{align*}
\end{proof}

Although we, in fact, have one extra buffer site left over, in practice it is often useful to use this site to permanently retain the very first or the very most recent data item.


% $t = \left\lfloor x \right\rfloor_\mathrm{bin} - s + 1$


% Recall that at epoch $t$, the greatest encountered h.v. is $t + s$
% \begin{align*}
% 1 + \sum_{i=1}^{s} 2^{i - 1} = 2^s = S.
% \end{align*}

So, each epoch, all items with $\colorH(\colorT) = \colort - 1$ must be replaced by new items with higher hanoi value.
Note that, under this scheme, there are never retained items $\colorT$ such that $\colorH(\colorT) < \colort - 1$.

The remainder of the section examines how to arrange data item placement to enact the above hanoi value strategy.
We first detail the conceptual mechanism of the algorithm in managing buffer layout.
We subsequently justify the correctness and viability of aspects of the mechanism.
Then, we prove a lower bound of the performance of the algorithm in upholding the steady criterion.

\subsection{Mechanism}

\input{fig/hsurf-steady-intuition}


\input{fig/hsurf-steady-implementation}

\subsection{Justification}

Let xj bj be the functions that give position for XXXX at time $T$.
We do not provide formal, closed-form definitions of them here but they can be computed in $\mathcal{O}(1)$ time with availability of binary operators (e.g., bit mask, bit shift, bitwise logical operators).


Suppose surface size $S = 2^s$ at rank $R$, with $r = \left\lceil \log_2 R \right\rceil$.
Note that $2 \times R \leq 2^r$.
In order for the steady algorithm to work, we need to have all values with hanoi value greater than or equal to
\begin{align*}
\max(r - s, 0)
\end{align*}

Recall that the distance between hanoi value instances is $2^{h + 1}$ and the distance between a hanoi value and a greater or equal hanoi value is $2^h$.
If we have $h = \max (r - s, 0)$, then gap size is at most $2^{\max(r - s, 0)}$.
The ideal gap size would be $\max( \left\lceil R / S \right\rceil, 1)$.

Can we bound the our bound on gap size is at most twice the ideal gap size?
\begin{align*}
\frac{
  2^{\max(r - s, 0)}
}{
  \max(\left\lceil R / S \right\rceil, 1)
}
&=
\frac{
  \max(2^r / 2^s, 1)
}{
  \max(\left\lceil R / S \right\rceil, 1)
} \\
&=
\frac{
  \max(2^r / S, 1)
}{
  \max(\left\lceil R / S \right\rceil, 1)
} \\
&\leq
\frac{
  \max(2R / S, 1)
}{
  \max(\left\lceil R / S \right\rceil, 1)
} \\
&\stackrel{\checkmark}{\leq} 2.
\end{align*}

We will have seen 1 of hv $r - 1$, 2 of hv $r - 2$, 4 of hv $r - 4$, and $2 ^ {s - 1}$ of hv $\max(r - s, 0)$.
In general, we will have seen $\left\lfloor 2 ^ (r - h) \right\rfloor$ instances of hanoi value $h$ by epoch $r$.
Recall $\sum_{i = 0}^{q} 2^i = 2 ^ {q + 1} - 1$.
Do we have enough space?
\begin{align*}
\sum_{i = 0}^{(r - 1) - \max(r - s, 0)} 2 ^ i \\
&= \sum_{i = 0}^{\min(r - 1, s - 1)} 2 ^ i \\
&\leq \sum_{i = 0}^{s - 1} 2 ^ i \\
&\leq 2^s - 1\\
&\stackrel{\checkmark}{\leq} 2^s
\end{align*}

Need to prove:
\begin{itemize}
\item the number of reservation slots in $j$th reservation equals the number of hanoi value instances observed during any window where $r = k$.
\item note, because we always fill completely we will therefore drop instances of hanoi value $r - s - 1$.
\item that hanoi value $r - s - 1$ is in the $h \mod n$th slot
\end{itemize}

The hanoi value $h = r - j$ is placed in the $j$th reservation during epoch $r$.
The $j$th reservation has $s - j$ slot size.
So, at epoch $r$ in reservation $j$ the hanoi value $h(j, r)$ will overwrite hanoi value
\begin{align*}
h(j, r) - (s - j) - 1 \\
&= (r - j) - (s - j) - 1 \\
&\stackrel{\checkmark}{=} r - s - 1.
\end{align*}

The $j$th reservation has $\max(1, 2^{j - 1})$ slots.
The number of new observations of hanoi value during epoch $r$ is $h$ is $\# h(r) -  \# h(r - 1)$.
This is
\begin{align*}
\left\lfloor 2 ^ {r - h} \right\rfloor - \left\lfloor 2 ^ {r - h - 1} \right\rfloor \\
&= \left\lfloor 2 ^{r - (r - j)} \right\rfloor - \left\lfloor 2 ^ {r - (r - j) - 1} \right\rfloor \\
&= 2^j - \left\lfloor 2 ^ {j - 1} \right\rfloor \\
&= \min(2^j - 2^{j - 1}, 1) \\
&= \min(2 \times 2^{j - 1} - 2^{j - 1}, 1) \\
&\stackrel{\checkmark}{=} \min(2^{j - 1}, 1).
\end{align*}


\subsection{Criterion Satisfaction}

Take buffer size $\colorS$ at time $\colorT$.
At any one point in time, the best possible coverage is $\left\lceil \colorT / \colorS \right\rceil$.
The proposed curation algorithm achieves no worse than this by a constant factor.

\begin{theorem}[Steady Algorithm Worst-case Gap Size]
\label{thm:steady-gap-size}
Under the steady curation algorithm, no gap size exceeds $\left\lceil 2 \colorT / \colorS \right\rceil$.  %TODO check this
\end{theorem}
\begin{proof}
TODO
\end{proof}
